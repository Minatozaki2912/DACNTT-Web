<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T√¨m ki·∫øm s·∫£n ph·∫©m | FashionClip</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    * {margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif;}
    body {background: #f9fafb; color: #333;}

    /* ---------------- NAVBAR ---------------- */
    nav {
      position: sticky; top: 0; width: 100%;
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 60px; background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 10;
    }
    nav h1 {font-size: 22px; font-weight: 700; color: #00a896; cursor: pointer;}
    nav h1 span {color: #333;}
    nav ul {display: flex; list-style: none; gap: 25px; align-items: center;}
    nav ul li a, nav ul li button {
      text-decoration: none; color: #333; font-weight: 500;
      background: none; border: none; cursor: pointer; transition: 0.3s;
    }
    nav ul li a:hover, nav ul li button:hover {color: #00a896;}

    /* ---------------- SEARCH BAR ---------------- */
    .search-bar {
      display: flex; justify-content: center; align-items: center;
      margin: 30px auto 10px; gap: 12px; flex-wrap: wrap;
    }
    .search-input {
      width: 400px; padding: 12px 50px 12px 20px;
      border: 2px solid #00a896; border-radius: 30px;
      font-size: 15px; outline: none; background: #fff;
    }
    .search-btn {
      position: relative; right: 45px; top: 2px; color: #fff;
      background: #00a896; border: none; border-radius: 50%;
      width: 38px; height: 38px; cursor: pointer; transition: 0.3s;
    }
    .search-btn:hover {background: #00796b;}
    .upload-btn {
      border: 2px dashed #00a896; padding: 10px 18px;
      border-radius: 30px; background: #fff; cursor: pointer;
      display: flex; align-items: center; gap: 8px; color: #00a896; font-weight: 500;
      transition: all 0.3s;
    }
    .upload-btn:hover {background: #e0f7f4;}

    /* ---------------- FILTERS ---------------- */
    .filters {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
      margin: 20px 0;
    }
    .filters select, .filters input {
      padding: 10px 14px; border-radius: 10px; border: 2px solid #eee;
      min-width: 140px; background: white; font-size: 14px;
    }

    /* ---------------- PRODUCTS GRID ---------------- */
    .grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 25px; max-width: 1100px; margin: 0 auto 40px; padding: 0 20px;
    }
    .card {
      background: #fff; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden; transition: 0.3s; text-align: center;
    }
    .card:hover {transform: translateY(-6px); box-shadow: 0 6px 20px rgba(0,0,0,0.15);}
    .card img {width: 100%; height: 280px; object-fit: cover;}
    .card h3 {font-size: 17px; margin: 12px 0 6px; color: #222;}
    .card p {color: #777; margin-bottom: 8px;}
    .card button {
      margin-bottom: 18px; padding: 8px 18px; border: none;
      border-radius: 20px; background: #00bfa5; color: white; cursor: pointer;
    }
    .card button:hover {background: #00796b;}

    /* ---------------- LOADING ---------------- */
    .loading {position: fixed; inset: 0; background: rgba(255,255,255,.7);
      display: flex; justify-content: center; align-items: center; z-index: 9999;}
    .spinner {
      width: 45px; height: 45px; border: 4px solid #00a896; border-top-color: transparent;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin {to {transform: rotate(360deg)}}

    footer {
      text-align: center; padding: 25px; color: #777;
      font-size: 14px; background: #f4f4f4;
    }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav>
    <h1 onclick="location='index.html'">Fashion<span>Clip</span></h1>
    <ul>
      <li><a href="index.html">Trang ch·ªß</a></li>
      <li><a href="search.html">T√¨m ki·∫øm</a></li>
      <li><a href="login.html" id="loginLink">ƒêƒÉng nh·∫≠p</a></li>
      <li><a href="register.html" id="registerLink">ƒêƒÉng k√Ω</a></li>
      <li><button id="logoutBtn" style="display:none;">ƒêƒÉng xu·∫•t</button></li>
    </ul>
  </nav>

  <!-- SEARCH AREA -->
  <div class="search-bar">
    <input type="text" id="searchInput" class="search-input" placeholder="T√¨m s·∫£n ph·∫©m...">
    <button class="search-btn" id="searchBtn"><i class="ri-search-line"></i></button>
    <label class="upload-btn">
      <i class="ri-image-line"></i> T√¨m b·∫±ng ·∫£nh
      <input type="file" id="imageUpload" accept="image/*" hidden>
    </label>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <select id="categorySelect"><option value="">T·∫•t c·∫£ danh m·ª•c</option></select>
    <input type="number" id="minPrice" placeholder="Gi√° t·ª´" min="0">
    <input type="number" id="maxPrice" placeholder="ƒê·∫øn" min="0">
    <select id="sortSelect">
      <option value="relevance">Ph√π h·ª£p nh·∫•t</option>
      <option value="newest">M·ªõi nh·∫•t</option>
      <option value="price_asc">Gi√° tƒÉng d·∫ßn</option>
      <option value="price_desc">Gi√° gi·∫£m d·∫ßn</option>
    </select>
  </div>

  <div id="meta" style="text-align:center; color:#555; margin-bottom:10px;"></div>
  <div class="grid" id="grid"></div>

  <footer>¬© 2025 FashionClip | Designed by Ho√†ng V∆∞∆°ng üíö</footer>

  <script>
    const token = localStorage.getItem("token");
    const loginLink = document.getElementById("loginLink");
    const registerLink = document.getElementById("registerLink");
    const logoutBtn = document.getElementById("logoutBtn");

    if (token) {
      loginLink.style.display = "none";
      registerLink.style.display = "none";
      logoutBtn.style.display = "inline";
    }

    logoutBtn.addEventListener("click", () => {
      Swal.fire({
        title: "ƒêƒÉng xu·∫•t?",
        text: "B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "ƒêƒÉng xu·∫•t",
        cancelButtonText: "H·ªßy",
        confirmButtonColor: "#00a896",
        cancelButtonColor: "#d33"
      }).then((r) => {
        if (r.isConfirmed) {
          localStorage.clear();
          Swal.fire({ icon: "success", title: "ƒêƒÉng xu·∫•t th√†nh c√¥ng!", timer: 1500, showConfirmButton: false });
          setTimeout(() => (window.location.href = "login.html"), 1500);
        }
      });
    });

    // ---------- SEARCH FUNCTION ----------
    let state = { q: "", category: "", min: "", max: "", sort: "relevance" };
    const els = {
      q: document.getElementById("searchInput"),
      btn: document.getElementById("searchBtn"),
      grid: document.getElementById("grid"),
      meta: document.getElementById("meta"),
      cat: document.getElementById("categorySelect"),
      min: document.getElementById("minPrice"),
      max: document.getElementById("maxPrice"),
      sort: document.getElementById("sortSelect"),
      upload: document.getElementById("imageUpload")
    };

    const showLoad = (b) => {
      if (b) {
        const d = document.createElement("div");
        d.className = "loading";
        d.id = "load";
        d.innerHTML = '<div class="spinner"></div>';
        document.body.append(d);
      } else document.getElementById("load")?.remove();
    };

    async function fetchCats() {
      try {
        const r = await fetch("http://localhost:3000/api/products/categories");
        const c = await r.json();
        els.cat.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>' + c.map(x => `<option>${x}</option>`).join("");
      } catch {}
    }

    async function searchProducts() {
      showLoad(true);
      const params = new URLSearchParams({
        q: state.q, category: state.category, min: state.min, max: state.max, sort: state.sort
      });
      const res = await fetch("http://localhost:3000/api/products/search?" + params);
      const data = await res.json();
      showLoad(false);

      els.grid.innerHTML = "";
      els.meta.innerHTML = data.total ? `T√¨m th·∫•y <b>${data.total}</b> k·∫øt qu·∫£` : "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m üßê";

      data.items.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${p.image || 'https://via.placeholder.com/300'}">
          <h3>${p.name}</h3>
          <p>${p.category || ''}</p>
          <p><b>${p.price.toLocaleString('vi-VN')}‚Ç´</b></p>
          <button onclick="location='product.html?id=${p._id}'">Xem chi ti·∫øt</button>
        `;
        els.grid.appendChild(card);
      });
    }

    // ---------- IMAGE SEARCH ----------
    els.upload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      showLoad(true);
      const formData = new FormData();
      formData.append("image", file);
      const res = await fetch("http://localhost:3000/api/products/search-image", { method: "POST", body: formData });
      const data = await res.json();
      showLoad(false);
      els.grid.innerHTML = "";
      els.meta.innerHTML = data.total ? `üîç K·∫øt qu·∫£ t∆∞∆°ng t·ª± h√¨nh ·∫£nh (${data.total})` : "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p üñºÔ∏è";

      data.items.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${p.image || 'https://via.placeholder.com/300'}">
          <h3>${p.name}</h3>
          <p>${p.category || ''}</p>
          <p><b>${p.price.toLocaleString('vi-VN')}‚Ç´</b></p>
          <button onclick="location='product.html?id=${p._id}'">Xem chi ti·∫øt</button>
        `;
        els.grid.appendChild(card);
      });
    });

    // ---------- EVENT ----------
    els.q.addEventListener("keypress", e => { if (e.key === "Enter") { state.q = e.target.value; searchProducts(); } });
    els.btn.onclick = () => { state.q = els.q.value; searchProducts(); };
    [els.cat, els.min, els.max, els.sort].forEach(el => el.onchange = () => {
      state.category = els.cat.value; state.min = els.min.value; state.max = els.max.value; state.sort = els.sort.value;
      searchProducts();
    });

    (async () => { await fetchCats(); })();
  </script>
</body>
</html>
